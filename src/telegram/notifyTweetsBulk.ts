import {Tweet} from "agent-twitter-client";
import {bot} from "./telegramBot";

const CHAT_ID = -1002108370914;

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–≤–∏—Ç–∞.
 */
export async function notifyTweetsBulk(username: string, tweets: Tweet[]) {
    if (tweets.length === 0) return;

    for (const tweet of tweets) {
        // –°—Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Å–∞–º —Ç–≤–∏—Ç
        // –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª–µ tweet.permanentUrl, –µ—Å–ª–∏ Scraper –µ–≥–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç,
        // –∏–ª–∏ —Å–æ–±—Ä–∞—Ç—å –≤—Ä—É—á–Ω—É—é: https://twitter.com/<username>/status/<id>
        const tweetLink = tweet.permanentUrl
            ? tweet.permanentUrl
            : `https://twitter.com/${tweet.username}/status/${tweet.id}`;

        // –î–∞—Ç–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ (tweet.timeParsed –º–æ–∂–µ—Ç –±—ã—Ç—å Date, –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –Ω–µ undefined)
        let dateString = "";
        if (tweet.timeParsed) {
            // –ú–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å dayjs –∏–ª–∏ –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä,
            // –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ toLocaleString():
            dateString = `\nüïí ${tweet.timeParsed.toLocaleString()}`;
        }

        // –°–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        const message =
            ```<b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> <a href="https://twitter.com/${tweet.username}">${tweet.name || tweet.username}</a>
            <b>–¢–µ–∫—Å—Ç:</b> ${tweet.text || ""}
            ${dateString}
            <b>–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–≤–∏—Ç:</b> <a href="${tweetLink}">${tweetLink}</a>`.trim();

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º HTML-—Ä–∞–∑–º–µ—Ç–∫–∏
        await bot.api.sendMessage(
            CHAT_ID,
            message,
            {
                parse_mode: "HTML",
                disable_web_page_preview: false // –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–µ–≤—å—é —Å—Å—ã–ª–æ–∫ (–¥–ª—è —Ñ–æ—Ç–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä)
            }
        );
    }

    console.log(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${tweets.length} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Ç–≤–∏—Ç–∞—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${username}".`);
}